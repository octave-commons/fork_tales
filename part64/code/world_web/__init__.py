from __future__ import annotations
import subprocess
import os
import json
import time
from urllib.request import urlopen
from urllib.error import URLError

from .paths import (
    discover_part_roots,
    _eta_mu_substrate_root,
    _eta_mu_inbox_root,
    _eta_mu_knowledge_archive_root,
    _eta_mu_knowledge_index_path,
    _eta_mu_registry_path,
    _eta_mu_output_root,
    _study_snapshot_log_path,
    _embeddings_db_path,
    _file_graph_moves_path,
    _safe_rel_path,
    _ensure_receipts_log_path,
    _locate_receipts_log,
    _parse_receipt_line,
    _split_receipt_refs,
    _append_receipt_line,
)
from .constants import (
    ENTITY_MANIFEST,
    VOICE_LINE_BANK,
    AUDIO_SUFFIXES,
    IMAGE_SUFFIXES,
    VIDEO_SUFFIXES,
    WS_MAGIC,
    MAX_SIM_POINTS,
    SIM_TICK_SECONDS,
    CATALOG_REFRESH_SECONDS,
    CATALOG_BROADCAST_HEARTBEAT_SECONDS,
    DAIMO_PROFILE_DEFS,
    CANONICAL_NAMED_FIELD_IDS,
    ETA_MU_INBOX_DIRNAME,
    ETA_MU_KNOWLEDGE_RECORD,
    ETA_MU_INGEST_VECSTORE_LAYER_MODE,
    ETA_MU_INBOX_DEBOUNCE_SECONDS,
    DOCKER_AUTORESTART_ENABLED,
    FIELD_TO_PRESENCE,
    COUNCIL_MIN_OVERLAP_MEMBERS,
    DOCKER_AUTORESTART_REQUIRE_COUNCIL,
    ETA_MU_INGEST_VECSTORE_COLLECTION,
    DOCKER_AUTORESTART_INCLUDE_GLOBS,
    DOCKER_AUTORESTART_EXCLUDE_GLOBS,
    DOCKER_AUTORESTART_REQUIRE_COUNCIL,
    DOCKER_AUTORESTART_SERVICES,
    DOCKER_AUTORESTART_TIMEOUT_SECONDS,
)

from .metrics import (
    RuntimeInfluenceTracker,
    _INFLUENCE_TRACKER,
    _safe_float,
    _safe_int,
    _clamp01,
    _status_from_utilization,
    _safe_env_metric,
    _parse_proc_meminfo_mb,
    _tail_text_lines,
    _collect_nvidia_metrics,
    _resource_log_watch,
    _resource_auto_embedding_order,
    _resource_auto_text_order,
    _resource_monitor_snapshot,
    _stable_ratio,
)
from .ai import (
    analyze_utterance,
    build_chat_reply,
    build_image_commentary,
    build_voice_lines,
    build_presence_say_payload,
    detect_artifact_refs,
    transcribe_audio_bytes,
    utterances_to_ledger_rows,
    _ollama_base_url,
    _ollama_endpoint,
    _ollama_embed,
    _embedding_backend,
    _text_generation_backend,
    _embedding_provider_options,
    _apply_embedding_provider_options,
    _load_tensorflow_module,
    _tensorflow_generate_text,
    _tensorflow_embed,
    _ollama_generate_text,
    _ollama_generate_text_remote,
    _embedding_provider_status,
    _openvino_embed,
    _ollama_embed_remote,
)
from .chamber import (
    CouncilChamber,
    TaskQueue,
    build_drift_scan_payload,
    build_witness_lineage_payload,
    build_world_log_payload,
    build_push_truth_dry_run_payload,
    build_study_snapshot,
    build_pi_archive_payload,
    validate_pi_archive_portable,
    export_study_snapshot,
    _council_auto_vote,
)
from .db import (
    _load_myth_tracker_class,
    _load_life_tracker_class,
    _load_life_interaction_builder,
    _get_chroma_collection,
    _load_mycelial_echo_documents,
    _embedding_db_upsert,
    _append_study_snapshot_event,
    _embedding_db_status,
    _embedding_db_list,
    _embedding_db_query,
    _embedding_db_delete,
    _create_image_comment,
    _list_image_comments,
    _list_presence_accounts,
    _load_study_snapshot_events,
    _upsert_presence_account,
)
from .catalog import (
    collect_catalog,
    load_manifest,
    build_world_payload,
    resolve_library_member,
    resolve_library_path,
    _read_library_archive_member,
    sync_eta_mu_inbox,
    _eta_mu_space_forms,
)
from .projection import (
    attach_ui_projection,
    build_ui_projection,
    normalize_projection_perspective,
    projection_perspective_options,
)
from .simulation import (
    build_simulation_delta,
    build_simulation_state,
    build_mix_stream,
    _file_id_for_path,
    _load_test_signal_artifacts,
    _fetch_weaver_graph_payload,
    _build_pain_field,
    _materialize_heat_values,
    _stable_entity_id,
    _normalize_path_for_file_id,
)
from .presence_runtime import (
    InMemoryPresenceStorage,
    PresenceRuntimeManager,
    get_presence_runtime_manager,
    reset_presence_runtime_state_for_tests,
    sync_presence_runtime_state,
)
from .muse_runtime import (
    MuseRuntimeManager,
    get_muse_runtime_manager,
    reset_muse_runtime_state_for_tests,
)
from .server import (
    main,
    serve,
    make_handler,
    resolve_artifact_path,
    websocket_accept_value,
    websocket_frame_text,
    render_index,
)
