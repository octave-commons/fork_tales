import{c as g,r as d,j as e}from"./index-DKUSIun3.js";const ie=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],G=g("circle-check",ie);const ce=[["path",{d:"m12 14 4-4",key:"9kzdfg"}],["path",{d:"M3.34 19a10 10 0 1 1 17.32 0",key:"19p75a"}]],de=g("gauge",ce);const oe=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],U=g("refresh-cw",oe);const le=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]],B=g("shield-alert",le);const ue=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],xe=g("triangle-alert",ue);function x(s,a,r){return Math.min(r,Math.max(a,s))}function H(s){if(!s)return"n/a";const a=Date.parse(s);if(!Number.isFinite(a))return s;const r=Date.now()-a,i=Math.round(r/1e3);return i<45?`${Math.max(0,i)}s ago`:i<3600?`${Math.round(i/60)}m ago`:i<86400?`${Math.round(i/3600)}h ago`:`${Math.round(i/86400)}d ago`}function me(s){const a=String(s||"").trim();return a?a.length<=68?a:`...${a.slice(-65)}`:"(n/a)"}function pe(s){return s==="executed"||s==="approved"?"text-[#a6e22e]":s==="blocked"?"text-[#fd971f]":s==="error"?"text-[#f92672]":"text-[#66d9ef]"}function he(s){const a={high:0,medium:0,low:0};return s&&s.active_drifts.forEach(r=>{const i=String(r.severity||"").toLowerCase();if(i==="high"){a.high+=1;return}if(i==="medium"){a.medium+=1;return}a.low+=1}),a}function ge(s){const a=x(s.blockedGateCount/4,0,1)*.34,r=x(s.activeDrifts/8,0,1)*.18,i=x(s.queuePending/8,0,1)*.2,v=x(s.councilPending/5,0,1)*.16,b=s.truthBlocked?.12:0,y=1-a-r-i-v-b;return x(y,0,1)}function be(s){return s>=.8?"stable":s>=.56?"watch":"unstable"}function je({catalog:s,simulation:a}){const[r,i]=d.useState(null),[v,b]=d.useState(null),[y,_]=d.useState(null),[J,S]=d.useState(null),[Q,$]=d.useState(!1),[q,C]=d.useState(""),[M,N]=d.useState(""),[V,P]=d.useState(""),[W,E]=d.useState(""),u=d.useCallback(async()=>{const t=window.location.port==="5173"?"http://127.0.0.1:8787":"";$(!0),C("");try{const n=await fetch(`${t}/api/study?limit=10`);if(n.ok){const h=await n.json();i(h),b(h.council??null),_(h.queue??null),S(h.drift??null),P("study-v1"),E(h.generated_at||new Date().toISOString());return}if(n.status!==404)throw new Error(`/api/study failed: ${n.status}`);const[c,l,p]=await Promise.all([fetch(`${t}/api/council?limit=10`),fetch(`${t}/api/task/queue`),fetch(`${t}/api/drift/scan`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})})]);if(!c.ok)throw new Error(`/api/council failed: ${c.status}`);if(!l.ok)throw new Error(`/api/task/queue failed: ${l.status}`);if(!p.ok)throw new Error(`/api/drift/scan failed: ${p.status}`);const re=await c.json(),ne=await l.json(),ae=await p.json();i(null),b(re.council??null),_(ne.queue??null),S(ae),P("legacy"),E(new Date().toISOString())}catch(n){const c=n instanceof Error?n.message:"study fetch failed";C(c)}finally{$(!1)}},[]);d.useEffect(()=>{u();const t=window.setInterval(()=>{u()},6500);return()=>{window.clearInterval(t)}},[u]);const K=d.useCallback(async()=>{const t=window.location.port==="5173"?"http://127.0.0.1:8787":"";N("exporting evidence...");try{const n=await fetch(`${t}/api/study/export`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({label:"ui-panel",include_truth:!0,refs:["frontend:StabilityObservatoryPanel"]})});if(!n.ok)throw new Error(`/api/study/export failed: ${n.status}`);const c=await n.json(),l=String(c.event?.id||"").trim()||"(unknown)",p=Number(c.history?.count??0);N(`evidence exported ${l} (history=${p})`),u()}catch(n){const c=n instanceof Error?n.message:"study export failed";N(`export failed: ${c}`)}},[u]),z=r?.council??v??s?.council??null,f=r?.queue??y??s?.task_queue??null,o=r?.drift??J,D=r?.signals?.queue_pending_count??f?.pending_count??0,L=r?.signals?.council_pending_count??z?.pending_count??0,R=r?.signals?.blocked_gate_count??o?.blocked_gates.length??0,O=r?.signals?.active_drift_count??o?.active_drifts.length??0,k=!!(r?.signals?.truth_gate_blocked??a?.truth_state?.gate?.blocked??s?.truth_state?.gate?.blocked),m=r?.runtime?.resource??s?.presence_runtime?.resource_heartbeat,X=r?.signals?.resource_hot_count??m?.hot_devices?.length??0,Y=r?.signals?.resource_log_error_ratio??m?.log_watch?.error_ratio??0,Z=m?.devices?.cpu?.utilization??0,ee=m?.auto_backend?.embeddings_order?.join(" -> ")??"(n/a)",te=m?.auto_backend?.text_order?.join(" -> ")??"(n/a)",j=typeof r?.stability?.score=="number"?x(r.stability.score,0,1):ge({blockedGateCount:R,activeDrifts:O,queuePending:D,councilPending:L,truthBlocked:k}),se=r?.stability?.label??be(j),T=Math.round(j*100),w=he(o??null),A=(z?.decisions??[]).slice(0,6),I=(f?.pending??[]).slice(0,6),F=d.useMemo(()=>{if(r?.warnings&&r.warnings.length>0)return r.warnings;const t=[];return(o?.blocked_gates??[]).forEach(n=>{t.push({code:"gate.blocked",severity:"high",message:`${n.target}: ${n.reason}`})}),(o?.open_questions?.unresolved_count??0)>0&&t.push({code:"drift.open_questions",severity:"medium",message:`${o?.open_questions?.unresolved_count??0} open questions unresolved`}),t},[o?.blocked_gates,o?.open_questions?.unresolved_count,r?.warnings]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-xl border border-[rgba(102,217,239,0.32)] bg-[rgba(39,40,34,0.88)] p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-semibold flex items-center gap-2",children:[e.jsx(de,{size:16}),"Stability Observatory"]}),e.jsx("p",{className:"text-xs text-muted mt-1",children:"Live evidence feed for council, gates, drift pressure, queue load, resource heartbeat, and runtime alignment."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{u()},className:"border border-[var(--line)] rounded-md bg-[rgba(31,32,29,0.9)] px-3 py-1.5 text-xs font-semibold text-ink hover:bg-[rgba(55,56,48,0.92)]",children:e.jsxs("span",{className:"inline-flex items-center gap-1.5",children:[e.jsx(U,{size:14,className:Q?"animate-spin":""}),"Refresh"]})}),e.jsx("button",{type:"button",onClick:()=>{K()},className:"border border-[rgba(102,217,239,0.6)] rounded-md bg-[rgba(26,52,61,0.45)] px-3 py-1.5 text-xs font-semibold text-[#66d9ef] hover:bg-[rgba(26,52,61,0.6)]",children:"Export Evidence"})]})]}),e.jsxs("div",{className:"mt-3 rounded-lg border border-[var(--line)] bg-[rgba(31,32,29,0.9)] p-3",children:[e.jsxs("div",{className:"flex items-baseline justify-between gap-2",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted",children:"stability index"}),e.jsx("p",{className:"text-sm font-mono",children:e.jsxs("span",{className:j>=.72?"text-[#a6e22e]":j>=.56?"text-[#fd971f]":"text-[#f92672]",children:[T,"% (",se,")"]})})]}),e.jsx("div",{className:"mt-2 h-2 rounded-full overflow-hidden bg-[rgba(22,23,20,0.95)]",children:e.jsx("div",{className:"h-full transition-[width] duration-400",style:{width:`${T}%`,background:"linear-gradient(90deg, rgba(249,38,114,0.88), rgba(253,151,31,0.85), rgba(166,226,46,0.9))"}})}),e.jsxs("p",{className:"text-[11px] text-muted mt-2",children:["source ",e.jsx("code",{children:V||"unknown"})," | last evidence refresh ",e.jsx("code",{children:H(W)})]}),r?.runtime?e.jsxs("p",{className:"text-[11px] text-muted mt-1",children:["receipts ",e.jsx("code",{children:me(r.runtime.receipts_path)})," | within vault ",e.jsx("code",{children:String(r.runtime.receipts_path_within_vault)})]}):null]}),e.jsxs("div",{className:"mt-3 grid gap-2 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.84)] px-3 py-2",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-muted",children:"blocked gates"}),e.jsx("p",{className:"text-sm font-semibold text-ink",children:R})]}),e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.84)] px-3 py-2",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-muted",children:"active drifts"}),e.jsx("p",{className:"text-sm font-semibold text-ink",children:O})]}),e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.84)] px-3 py-2",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-muted",children:"queue pending"}),e.jsx("p",{className:"text-sm font-semibold text-ink",children:D})]}),e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.84)] px-3 py-2",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-muted",children:"council pending"}),e.jsx("p",{className:"text-sm font-semibold text-ink",children:L})]}),e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.84)] px-3 py-2",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-muted",children:"resource hot"}),e.jsx("p",{className:"text-sm font-semibold text-ink",children:X})]}),e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.84)] px-3 py-2",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-muted",children:"cpu utilization"}),e.jsxs("p",{className:"text-sm font-semibold text-ink",children:[Math.round(Z),"%"]})]})]}),e.jsxs("div",{className:"mt-3 grid gap-2 md:grid-cols-2",children:[e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.84)] px-3 py-2",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-muted",children:"truth gate"}),e.jsxs("p",{className:"text-sm font-semibold flex items-center gap-1.5",children:[k?e.jsx(B,{size:14,className:"text-[#f92672]"}):e.jsx(G,{size:14,className:"text-[#a6e22e]"}),k?"blocked":"clear"]})]}),e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.84)] px-3 py-2",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-muted",children:"drift severities"}),e.jsxs("p",{className:"text-sm font-mono text-ink",children:["high ",w.high," | medium ",w.medium," | low ",w.low]})]}),e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.84)] px-3 py-2 md:col-span-2",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-wide text-muted",children:"resource routing"}),e.jsxs("p",{className:"text-[11px] text-muted mt-1",children:["embeddings ",e.jsx("code",{children:ee})]}),e.jsxs("p",{className:"text-[11px] text-muted mt-1",children:["text ",e.jsx("code",{children:te})," | log error ratio ",e.jsx("code",{children:Y.toFixed(3)})]})]})]}),q?e.jsxs("p",{className:"mt-3 text-xs text-[#f92672]",children:["study refresh error: ",q]}):null,M?e.jsx("p",{className:"mt-1 text-xs text-muted",children:M}):null]}),e.jsxs("div",{className:"grid gap-4 xl:grid-cols-2",children:[e.jsxs("div",{className:"rounded-xl border border-[var(--line)] bg-[rgba(39,40,34,0.84)] p-3",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted",children:"Council Decisions"}),e.jsx("div",{className:"mt-2 space-y-2 max-h-[21rem] overflow-auto pr-1",children:A.length===0?e.jsx("p",{className:"text-xs text-muted",children:"No council decisions captured yet."}):A.map(t=>{const n=t.council?.tally,c=t.gate?.reasons??[],l=String(t.resource?.source_rel_path??"");return e.jsxs("article",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.86)] px-3 py-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-[11px] font-mono text-muted truncate",children:t.id}),e.jsx("p",{className:`text-xs font-semibold ${pe(t.status)}`,children:t.status})]}),e.jsxs("p",{className:"text-[11px] text-muted mt-1 truncate",children:["source: ",e.jsx("code",{children:l||"(unknown)"})]}),e.jsxs("p",{className:"text-[11px] text-muted",children:["votes: yes ",n?.yes??0," / no ",n?.no??0," / abstain ",n?.abstain??0," / req ",n?.required_yes??0]}),e.jsxs("p",{className:"text-[11px] text-muted",children:["action: ",e.jsx("code",{children:t.action?.result??"pending"}),t.action?.services&&t.action.services.length>0?` (${t.action.services.join(",")})`:""]}),c.length>0?e.jsxs("p",{className:"text-[11px] text-[#fd971f] truncate",children:["gate: ",c.join(", ")]}):null,e.jsx("p",{className:"text-[11px] text-muted",children:H(t.created_at)})]},t.id)})})]}),e.jsxs("div",{className:"rounded-xl border border-[var(--line)] bg-[rgba(39,40,34,0.84)] p-3",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted",children:"Queue and Gate Evidence"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.86)] p-2",children:[e.jsx("p",{className:"text-[11px] text-muted font-semibold",children:"Warnings"}),F.length===0?e.jsxs("p",{className:"text-[11px] text-[#a6e22e] mt-1 inline-flex items-center gap-1",children:[e.jsx(G,{size:12}),"none"]}):e.jsx("div",{className:"mt-1 space-y-1 max-h-[8rem] overflow-auto pr-1",children:F.slice(0,8).map((t,n)=>e.jsxs("p",{className:"text-[11px] text-[#fd971f]",children:[e.jsx(xe,{size:11,className:"inline-block mr-1"}),t.code,": ",t.message]},`${t.code}-${n}`))})]}),e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.86)] p-2",children:[e.jsx("p",{className:"text-[11px] text-muted font-semibold",children:"Pending tasks"}),I.length===0?e.jsx("p",{className:"text-[11px] text-[#a6e22e] mt-1",children:"queue clear"}):e.jsx("div",{className:"mt-1 space-y-1 max-h-[10rem] overflow-auto pr-1",children:I.map(t=>e.jsxs("p",{className:"text-[11px] text-ink truncate",children:[e.jsx("code",{children:t.kind})," :: ",t.id]},t.id))}),e.jsxs("p",{className:"text-[11px] text-muted mt-1",children:["dedupe keys ",e.jsx("code",{children:f?.dedupe_keys??0})," | events ",e.jsx("code",{children:f?.event_count??0})]})]}),e.jsxs("div",{className:"rounded-md border border-[var(--line)] bg-[rgba(31,32,29,0.86)] p-2",children:[e.jsx("p",{className:"text-[11px] text-muted font-semibold",children:"Interpretation"}),e.jsx("p",{className:"text-[11px] text-muted mt-1",children:"Stability drops when gate blocks accumulate, queue pressure rises, resource lanes run hot, and council decisions wait without closure."}),e.jsxs("p",{className:"text-[11px] text-muted mt-1 inline-flex items-center gap-1",children:[e.jsx(B,{size:11}),"Use ",e.jsx("code",{children:"/study"})," in chat for a compact evidence digest."]}),e.jsxs("p",{className:"text-[11px] text-muted mt-1 inline-flex items-center gap-1",children:[e.jsx(U,{size:11}),"Auto-refresh every 6.5s; manual refresh keeps snapshots explicit."]})]})]})]})]})]})}export{je as StabilityObservatoryPanel};
