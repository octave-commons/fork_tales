services:
  eta-mu-system:
    build:
      context: .
      dockerfile: Dockerfile.system
    command:
      [
        "pm2-runtime",
        "start",
        "ecosystem.bench.config.cjs",
        "--only",
        "eta-mu-world,eta-mu-io,web-graph-weaver",
      ]
    environment:
      CHROMA_HOST: chroma
      CHROMA_PORT: "8000"
      PYTHONUNBUFFERED: "1"
      WEAVER_HOST: "0.0.0.0"
      WEAVER_PORT: "8793"
      OLLAMA_BASE_URL: "http://host.docker.internal:11435"
      OLLAMA_MODEL: "qwen3-vl:4b-instruct"
      OLLAMA_TIMEOUT_SEC: "${OLLAMA_TIMEOUT_SEC:-4}"
      OLLAMA_NUM_GPU: "${OLLAMA_NUM_GPU:-1}"
      OLLAMA_MAIN_GPU: "${OLLAMA_MAIN_GPU:-0}"
      OLLAMA_EMBED_MODEL: "nomic-embed-text"
      OLLAMA_EMBED_FORCE_NOMIC: "1"
      OLLAMA_EMBED_NUM_CTX: "512"
      OLLAMA_EMBED_MAX_CHARS: "2400"
      OPENVINO_EMBED_ENDPOINT: "http://host.docker.internal:18000/v1/embeddings"
      OPENVINO_EMBED_MODEL: "nomic-embed-text"
      OPENVINO_EMBED_DEVICE: "NPU"
      OPENVINO_EMBED_TIMEOUT_SEC: "10"
      OPENVINO_EMBED_MAX_CHARS: "2400"
      OPENVINO_EMBED_API_KEY: "${OPENVINO_EMBED_API_KEY:-}"
      OPENVINO_EMBED_API_KEY_HEADER: "X-API-Key"
      OPENVINO_EMBED_BEARER_TOKEN: "${OPENVINO_EMBED_BEARER_TOKEN:-}"
      ETA_MU_TEXT_EMBED_MODEL: "nomic-embed-text"
      ETA_MU_IMAGE_EMBED_MODEL: "nomic-embed-text"
      WEAVER_LLM_BASE_URL: "http://host.docker.internal:11435"
      WEAVER_LLM_MODEL: "qwen3-vl:2b-instruct"
      WEAVER_LLM_TIMEOUT_MS: "30000"
      EMBEDDINGS_BACKEND: "openvino"
      CDB_EMBED_IN_C: "1"
      CDB_EMBED_REQUIRE_C: "1"
      CDB_EMBED_DEVICE: "AUTO"
      CDB_EMBED_STRICT_DEVICE: "1"
      CDB_EMBED_PRELOAD_ORT_CORE: "1"
      NVIDIA_VISIBLE_DEVICES: "${NVIDIA_VISIBLE_DEVICES:-all}"
      NVIDIA_DRIVER_CAPABILITIES: "${NVIDIA_DRIVER_CAPABILITIES:-compute,utility}"
      TORCH_EMBED_MODEL: "nomic-ai/nomic-embed-text-v1.5"
      TEXT_GENERATION_BACKEND: "auto"
      TF_EMBED_HASH_BINS: "768"
      SIM_PARTICLE_BACKEND: "cdb"
      SIM_TICK_SECONDS: "0.08"
      SIMULATION_WS_USE_CACHED_SNAPSHOTS: "1"
      SIMULATION_WS_CACHE_REFRESH_SECONDS: "60.0"
      SIMULATION_WS_CACHE_MAX_AGE_SECONDS: "86400.0"
      SIMULATION_WS_SKIP_CATALOG_BOOTSTRAP: "1"
      SIMULATION_WS_STREAM_VELOCITY_SCALE: "0.78"
      SIMULATION_WS_STREAM_FRICTION: "0.997"
      SIMULATION_WS_STREAM_MAX_SPEED: "0.08"
      SIMULATION_WS_STREAM_FIELD_FORCE: "0.34"
      SIMULATION_WS_STREAM_CENTER_GRAVITY: "0.14"
      SIMULATION_WS_STREAM_SWIRL_FORCE: "0.11"
      SIMULATION_WS_STREAM_JITTER_FORCE: "0.055"
      SIMULATION_WS_STREAM_SIMPLEX_SCALE: "1.7"
      SIMULATION_WS_STREAM_ORBIT_DECAY: "0.42"
      SIMULATION_PRESENCE_PROFILE: "${SIMULATION_PRESENCE_PROFILE:-concept_cpu}"
      SIMULATION_CORE_RESOURCES: "${SIMULATION_CORE_RESOURCES:-cpu}"
      SIMULATION_CPU_DAIMOI_STOP_PERCENT: "${SIMULATION_CPU_DAIMOI_STOP_PERCENT:-75}"
      CDB_TARGET_PARTICLES_PER_PRESENCE: "${CDB_TARGET_PARTICLES_PER_PRESENCE:-10}"
      CDB_TARGET_FILE_SQRT_FACTOR: "${CDB_TARGET_FILE_SQRT_FACTOR:-5}"
      CDB_TARGET_BASE_OFFSET: "${CDB_TARGET_BASE_OFFSET:-56}"
      CDB_TARGET_MIN_COUNT: "${CDB_TARGET_MIN_COUNT:-72}"
      CDB_TARGET_MAX_COUNT: "${CDB_TARGET_MAX_COUNT:-420}"
      DOCKER_SIMULATION_LABEL_KEY: "io.fork_tales.simulation"
      DOCKER_SIMULATION_ROLE_LABEL_KEY: "io.fork_tales.simulation.role"
      DOCKER_SIMULATION_NAME_HINTS: "eta-mu,muse-song,sim-slice,simulation,experiment"
      DOCKER_SIMULATION_NETWORK_HINT: "eta-mu-sim-net"
      DOCKER_SIMULATION_WS_REFRESH_SECONDS: "2.5"
      DOCKER_SIMULATION_WS_HEARTBEAT_SECONDS: "18"
      DOCKER_SIMULATION_RESOURCE_WORKERS: "10"
    labels:
      io.fork_tales.simulation: "true"
      io.fork_tales.simulation.role: "world-runtime"
      io.fork_tales.simulation.track: "core"
    depends_on:
      - chroma
      - ollama-loopback-proxy
    ports:
      - "${ETA_MU_WEAVER_PORT:-8793}:8793"
    cpus: "12.00"
    mem_limit: "24000m"
    memswap_limit: "24000m"
    pids_limit: 220
    gpus: all
    devices:
      - "/dev/accel:/dev/accel"
      - "/dev/dri:/dev/dri"
    volumes:
      - .:/app
      - ./world_state:/app/world_state
      - ../.opencode/runtime:/app/.opencode/runtime:ro
      - ../:/vault
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /usr/lib/x86_64-linux-gnu/libze_intel_npu.so:/usr/lib/x86_64-linux-gnu/libze_intel_npu.so:ro
      - /usr/lib/x86_64-linux-gnu/libnpu_driver_compiler.so:/usr/lib/x86_64-linux-gnu/libnpu_driver_compiler.so:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - eta-mu-sim-net
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8787/', timeout=6)",
        ]
      interval: 20s
      timeout: 12s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  eta-mu-gateway:
    image: nginx:1.27-alpine
    depends_on:
      - eta-mu-system
    ports:
      - "${ETA_MU_GATEWAY_PORT:-8787}:80"
    cpus: "0.35"
    mem_limit: "256m"
    memswap_limit: "256m"
    pids_limit: 72
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - eta-mu-sim-net
    restart: unless-stopped

  chroma:
    image: chromadb/chroma:latest
    cpus: "1.20"
    mem_limit: "1600m"
    memswap_limit: "1600m"
    pids_limit: 180
    volumes:
      - ./world_state/chroma_data:/chroma/chroma
    environment:
      IS_PERSISTENT: "TRUE"
    networks:
      - eta-mu-sim-net
    restart: unless-stopped

  ollama-loopback-proxy:
    image: alpine/socat:latest
    network_mode: host
    command: ["-d", "-d", "TCP-LISTEN:11435,reuseaddr,fork", "TCP:127.0.0.1:11434"]
    cpus: "0.20"
    mem_limit: "128m"
    memswap_limit: "128m"
    pids_limit: 64
    restart: unless-stopped

networks:
  eta-mu-sim-net:
    name: eta-mu-sim-net
    driver: bridge
