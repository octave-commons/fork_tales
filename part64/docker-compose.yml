services:
  eta-mu-system:
    build:
      context: .
      dockerfile: Dockerfile.system
    command:
      [
        "pm2-runtime",
        "start",
        "ecosystem.bench.config.cjs",
        "--only",
        "eta-mu-world,eta-mu-io,web-graph-weaver",
      ]
    environment:
      CHROMA_HOST: chroma
      CHROMA_PORT: "8000"
      PYTHONUNBUFFERED: "1"
      WEAVER_HOST: "0.0.0.0"
      WEAVER_PORT: "8793"
      TEXT_GENERATION_MODEL: "qwen3-vl:4b-instruct"
      TEXT_GENERATION_DEVICE: "GPU"
      OPENVINO_EMBED_MODEL: "nomic-embed-text"
      OPENVINO_EMBED_DEVICE: "NPU"
      OPENVINO_EMBED_MAX_CHARS: "2400"
      ETA_MU_TEXT_EMBED_MODEL: "nomic-embed-text"
      ETA_MU_IMAGE_EMBED_MODEL: "nomic-embed-text"
      WEAVER_LLM_ENABLED: "0"
      WEAVER_LLM_MODEL: "qwen3-vl:2b-instruct"
      WEAVER_LLM_TIMEOUT_MS: "30000"
      EMBEDDINGS_BACKEND: "openvino"
      CDB_EMBED_IN_C: "0"
      CDB_EMBED_REQUIRE_C: "0"
      CDB_EMBED_DEVICE: "NPU"
      CDB_EMBED_GPU_REQUIRE_CUDA: "1"
      CDB_EMBED_STRICT_DEVICE: "1"
      CDB_EMBED_PRELOAD_ORT_CORE: "1"
      NVIDIA_VISIBLE_DEVICES: "${NVIDIA_VISIBLE_DEVICES:-all}"
      NVIDIA_DRIVER_CAPABILITIES: "${NVIDIA_DRIVER_CAPABILITIES:-compute,utility}"
      TORCH_EMBED_MODEL: "nomic-ai/nomic-embed-text-v1.5"
      TEXT_GENERATION_BACKEND: "vllm"
      TEXT_GENERATION_BASE_URL: "${TEXT_GENERATION_BASE_URL:-http://host.docker.internal:18000}"
      ETA_MU_IMAGE_VISION_ENABLED: "${ETA_MU_IMAGE_VISION_ENABLED:-1}"
      ETA_MU_IMAGE_VISION_BASE_URL: "${ETA_MU_IMAGE_VISION_BASE_URL:-http://host.docker.internal:18000}"
      TF_EMBED_HASH_BINS: "768"
      SIM_PARTICLE_BACKEND: "cdb"
      SIM_TICK_SECONDS: "0.12"
      SIMULATION_WS_USE_CACHED_SNAPSHOTS: "1"
      SIMULATION_WS_BOOTSTRAP_REQUIRE_LIVE_REBUILD: "0"
      SIMULATION_WS_CACHE_REFRESH_SECONDS: "8"
      SIMULATION_WS_CACHE_MAX_AGE_SECONDS: "86400.0"
      SIMULATION_HTTP_CACHE_SECONDS: "15"
      SIMULATION_HTTP_STALE_FALLBACK_SECONDS: "45"
      SIMULATION_HTTP_CACHE_IGNORE_INFLUENCE: "1"
      SIMULATION_HTTP_CACHE_IGNORE_QUEUE: "1"
      SIMULATION_WS_SKIP_CATALOG_BOOTSTRAP: "1"
      SIMULATION_WS_STREAM_PARTICLE_MAX: "512"
      SIMULATION_WS_CHUNK_ENABLED: "0"
      SIMULATION_WS_CHUNK_CHARS: "96000"
      SIMULATION_WS_CHUNK_DELTA_MIN_CHARS: "262144"
      SIMULATION_WS_STREAM_VELOCITY_SCALE: "0.78"
      SIMULATION_WS_STREAM_DAIMOI_FRICTION: "0.994"
      SIMULATION_WS_STREAM_NEXUS_FRICTION: "0.872"
      SIMULATION_WS_STREAM_MAX_SPEED: "0.092"
      SIMULATION_WS_STREAM_NEXUS_MAX_SPEED_SCALE: "0.26"
      SIMULATION_WS_STREAM_DAIMOI_ORBIT_DAMPING: "1.35"
      SIMULATION_WS_STREAM_NEXUS_SEMANTIC_WEIGHT: "0.82"
      SIMULATION_WS_STREAM_SEMANTIC_WALLET_SCALE: "24"
      SIMULATION_WS_STREAM_NEXUS_STATIC_FRICTION: "0.026"
      SIMULATION_WS_STREAM_NEXUS_STATIC_RELEASE_SPEED: "0.032"
      SIMULATION_WS_STREAM_NEXUS_STATIC_CREEP: "0.18"
      SIMULATION_WS_STREAM_NEXUS_QUADRATIC_DRAG: "6.4"
      SIMULATION_WS_STREAM_NEXUS_DRAG_SPEED_REF: "0.045"
      SIMULATION_WS_STREAM_FIELD_FORCE: "0.34"
      SIMULATION_WS_STREAM_CENTER_GRAVITY: "0.14"
      SIMULATION_WS_STREAM_SWIRL_FORCE: "0.11"
      SIMULATION_WS_STREAM_JITTER_FORCE: "0.072"
      SIMULATION_WS_STREAM_SIMPLEX_SCALE: "2.05"
      SIMULATION_WS_STREAM_ORBIT_DECAY: "0.42"
      SIMULATION_PRESENCE_PROFILE: "${SIMULATION_PRESENCE_PROFILE:-full}"
      SIMULATION_CORE_RESOURCES: "${SIMULATION_CORE_RESOURCES:-cpu,ram,disk,network,gpu,npu}"
      SIMULATION_CPU_DAIMOI_STOP_PERCENT: "${SIMULATION_CPU_DAIMOI_STOP_PERCENT:-50}"
      SIMULATION_CPU_SENTINEL_BURN_START_PERCENT: "${SIMULATION_CPU_SENTINEL_BURN_START_PERCENT:-80}"
      SIMULATION_CPU_SENTINEL_BURN_MAX_MULTIPLIER: "${SIMULATION_CPU_SENTINEL_BURN_MAX_MULTIPLIER:-16}"
      SIMULATION_CPU_SENTINEL_BURN_COST_MAX: "${SIMULATION_CPU_SENTINEL_BURN_COST_MAX:-0.8}"
      SIMULATION_CPU_SENTINEL_ATTRACTOR_START_PERCENT: "${SIMULATION_CPU_SENTINEL_ATTRACTOR_START_PERCENT:-90}"
      SIMULATION_CPU_SENTINEL_ATTRACTOR_GAIN: "${SIMULATION_CPU_SENTINEL_ATTRACTOR_GAIN:-2.0}"
      SIMULATION_CPU_SENTINEL_ATTRACTOR_RESOURCE_BOOST: "${SIMULATION_CPU_SENTINEL_ATTRACTOR_RESOURCE_BOOST:-5.0}"
      SIMULATION_CPU_SENTINEL_ATTRACTOR_ALL_DAIMOI: "${SIMULATION_CPU_SENTINEL_ATTRACTOR_ALL_DAIMOI:-1}"
      CDB_TARGET_PARTICLES_PER_PRESENCE: "${CDB_TARGET_PARTICLES_PER_PRESENCE:-24}"
      CDB_TARGET_FILE_SQRT_FACTOR: "${CDB_TARGET_FILE_SQRT_FACTOR:-8}"
      CDB_TARGET_BASE_OFFSET: "${CDB_TARGET_BASE_OFFSET:-256}"
      CDB_TARGET_MIN_COUNT: "${CDB_TARGET_MIN_COUNT:-384}"
      CDB_TARGET_MAX_COUNT: "${CDB_TARGET_MAX_COUNT:-2048}"
      CDB_FORCE_WORKERS: "${CDB_FORCE_WORKERS:-2}"
      CDB_COLLISION_WORKERS: "${CDB_COLLISION_WORKERS:-2}"
      CDB_SIM_FLAGS: "${CDB_SIM_FLAGS:-1}"
      CDB_FORCE_SLEEP_US: "${CDB_FORCE_SLEEP_US:-0}"
      CDB_CHAOS_SLEEP_US: "${CDB_CHAOS_SLEEP_US:-0}"
      CDB_INTEGRATE_SLEEP_US: "${CDB_INTEGRATE_SLEEP_US:-0}"
      CDB_SEMANTIC_SLEEP_US: "${CDB_SEMANTIC_SLEEP_US:-0}"
      CDB_BH_THETA: "${CDB_BH_THETA:-0.62}"
      CDB_BH_LEAF_CAP: "${CDB_BH_LEAF_CAP:-8}"
      CDB_BH_MAX_DEPTH: "${CDB_BH_MAX_DEPTH:-12}"
      CDB_COLLISION_SPRING: "${CDB_COLLISION_SPRING:-80}"
      CDB_CLUSTER_THETA: "${CDB_CLUSTER_THETA:-0.68}"
      CDB_CLUSTER_REST_LENGTH: "${CDB_CLUSTER_REST_LENGTH:-0.08}"
      CDB_CLUSTER_STIFFNESS: "${CDB_CLUSTER_STIFFNESS:-1.0}"
      DOCKER_SIMULATION_LABEL_KEY: "io.fork_tales.simulation"
      DOCKER_SIMULATION_ROLE_LABEL_KEY: "io.fork_tales.simulation.role"
      DOCKER_SIMULATION_NAME_HINTS: "eta-mu,muse-song,sim-slice,simulation,experiment"
      DOCKER_SIMULATION_NETWORK_HINT: "eta-mu-sim-net"
      DOCKER_SIMULATION_WS_REFRESH_SECONDS: "2.5"
      DOCKER_SIMULATION_WS_HEARTBEAT_SECONDS: "18"
      DOCKER_SIMULATION_RESOURCE_WORKERS: "1"
      RUNTIME_CATALOG_SUBPROCESS_ENABLED: "0"
      RUNTIME_ETA_MU_SYNC_ENABLED: "0"
      RUNTIME_ETA_MU_SYNC_SECONDS: "300.0"
    labels:
      io.fork_tales.simulation: "true"
      io.fork_tales.simulation.role: "world-runtime"
      io.fork_tales.simulation.track: "core"
    depends_on:
      - chroma
    ports:
      - "${ETA_MU_WEAVER_PORT:-8793}:8793"
    cpus: "12.00"
    mem_limit: "20000m"
    memswap_limit: "20000m"
    pids_limit: 1024
    gpus: all
    devices:
      - "/dev/accel:/dev/accel"
      - "/dev/dri:/dev/dri"
    volumes:
      - .:/app
      - ./world_state:/app/world_state
      - ../.opencode/runtime:/app/.opencode/runtime:ro
      - ../:/vault
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /usr/lib/x86_64-linux-gnu/libze_intel_npu.so:/usr/lib/x86_64-linux-gnu/libze_intel_npu.so:ro
      - /usr/lib/x86_64-linux-gnu/libnpu_driver_compiler.so:/usr/lib/x86_64-linux-gnu/libnpu_driver_compiler.so:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - eta-mu-sim-net
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8787/', timeout=6)",
        ]
      interval: 20s
      timeout: 12s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  eta-mu-gateway:
    image: nginx:1.27-alpine
    depends_on:
      - eta-mu-system
    ports:
      - "${ETA_MU_GATEWAY_PORT:-8787}:80"
    cpus: "0.35"
    mem_limit: "256m"
    memswap_limit: "256m"
    pids_limit: 72
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - eta-mu-sim-net
    restart: unless-stopped

  chroma:
    image: chromadb/chroma:latest
    cpus: "1.20"
    mem_limit: "1600m"
    memswap_limit: "1600m"
    pids_limit: 180
    volumes:
      - ./world_state/chroma_data:/chroma/chroma
    environment:
      IS_PERSISTENT: "TRUE"
    networks:
      - eta-mu-sim-net
    restart: unless-stopped

networks:
  eta-mu-sim-net:
    name: eta-mu-sim-net
    driver: bridge
